using System;
using System.IO;
using Renci.SshNet;

namespace SftpDirectoryMirror
{
    class Program
    {
        // SFTPサーバーの接続情報
        private const string SftpHost = "example.com";
        private const int SftpPort = 22;
        private const string SftpUsername = "username";
        private const string SftpPassword = "password";

        // SFTPサーバ上の対象ディレクトリ（ルートパス）
        private const string SftpRootPath = "/path/to/source";

        // ローカルに作成するルートパス
        private const string LocalRootPath = @"C:\SftpMirror";

        static void Main(string[] args)
        {
            try
            {
                Console.WriteLine("SFTPサーバーのディレクトリ構造をミラーリング開始...");

                // SSH.NET の SftpClient を使用して SFTP 接続を確立
                using (var client = new SftpClient(SftpHost, SftpPort, SftpUsername, SftpPassword))
                {
                    client.Connect();
                    ProcessSftpDirectory(client, SftpRootPath, LocalRootPath);
                    client.Disconnect();
                }

                Console.WriteLine("処理完了しました。");
            }
            catch (Exception ex)
            {
                Console.WriteLine("エラーが発生しました: " + ex.Message);
            }
        }

        /// <summary>
        /// SFTPサーバ上のディレクトリを再帰的に走査し、同じ構造をローカルに作成します。
        /// ファイルは同名で作成し、内容は「Dummy」とします。
        /// </summary>
        /// <param name="client">接続済みの SftpClient インスタンス</param>
        /// <param name="sftpPath">SFTPサーバ上の対象ディレクトリのパス</param>
        /// <param name="localPath">ローカルに作成するディレクトリのパス</param>
        private static void ProcessSftpDirectory(SftpClient client, string sftpPath, string localPath)
        {
            // ローカルにディレクトリが存在しなければ作成
            if (!Directory.Exists(localPath))
            {
                Directory.CreateDirectory(localPath);
                Console.WriteLine("作成: " + localPath);
            }

            // SFTPサーバ上のディレクトリ内のエントリ一覧を取得
            var entries = client.ListDirectory(sftpPath);
            foreach (var entry in entries)
            {
                // "." と ".." はスキップ
                if (entry.Name == "." || entry.Name == "..")
                    continue;

                // マルチバイト文字を含む可能性に備えて、ファイル名を正規化
                string safeName = entry.Name.Normalize();  
                string sftpFullPath = $"{sftpPath.TrimEnd('/')}/{safeName}";
                string localFullPath = Path.Combine(localPath, safeName);

                if (entry.IsDirectory)
                {
                    // ディレクトリの場合は再帰的に処理
                    ProcessSftpDirectory(client, sftpFullPath, localFullPath);
                }
                else if (entry.IsRegularFile)
                {
                    // ファイルの場合：ローカルに「Dummy」文字列を内容とするファイルを作成
                    try
                    {
                        File.WriteAllText(localFullPath, "Dummy");
                        Console.WriteLine("ファイル作成: " + localFullPath);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine("ファイル作成失敗: " + localFullPath + " (" + ex.Message + ")");
                    }
                }
            }
        }
    }
}
